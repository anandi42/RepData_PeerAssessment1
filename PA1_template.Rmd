---
title: "Reproducible Research Peer Assesment 1"
output:
  html_document:
    fig_caption: yes
    fig_height: 4.5
    fig_width: 6.5
    keep_md: yes
---
##Introduction
Personal activity monitoring devices allow users to collect a large amount of data about themselves. In this report, we will analyze of set of such data.  
The data used in this report was obtained [here](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip).

Setup steps and packages used:
```{r setup, echo=TRUE, results='hide', message=FALSE, warning=FALSE, cache=TRUE}
setwd("~/data")
rm(list = ls())
library(dplyr)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(lubridate)
```


##Load and Process Data 
First, we need to load and read in the data. We can see that the data consists of three variables, "steps", "date", and "interval".  

* Steps: Number of steps taking in a 5-minute interval (missing values are coded as NA)  
* date: The date on which the measurement was taken in YYYY-MM-DD format.
+The data come from a two-month period of data.    
* interval: Identifier for the 5-minute interval in which measurement was taken.
+This interval is given as a numeric value from 0 to 2355, representing five-minute segments (i.e 830=8:30 AM, while 2200=10 PM).  

The pre-processing steps will create dataframes that summarize the daily steps by date, and also by interval, in a subset of the original data that has NAs removed. 

```{r processing, echo=TRUE, dependson=1, cache=TRUE}
fileurl="http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip"
filename <- "activity.zip"
if (file.exists(filename)) {
  print("File present!")
  } else {download.file(fileurl, destfile="activity.zip")}
#This is the main data
activity <- read.csv(unz("activity.zip","activity.csv"))
head(activity) 
#For now, remove NA's
act_clean <- activity[!is.na(activity$steps),]
#Agrregated dataframes by day and by interval
bydate <- act_clean %>%
          group_by(date) %>%
          summarize(steps=sum(steps)) 
          
byint <- act_clean %>%
          group_by(interval) %>%
          summarize(steps=mean(steps))
```

##What is mean total number of steps taken per day?
To answer the question, we plot a histogram of the dataset bydate, which contains the summed steps taken for every day of the dataset. Using the  pacakge [gridExtra](http://cran.r-project.org/web/packages/gridExtra/gridExtra.pdf), we can annotate the plot with the calculated mean and median. 

```{r plot1, echo=TRUE, dependson=c(1,2), cache=TRUE, fig.cap="Distribution of total daily steps"}
means <- data.frame(Mean=signif(mean(bydate$steps), digits=7), Median=signif(median(bydate$steps), digits=7))

plot <- ggplot(data=bydate, aes(bydate$steps))
plot1 <- plot + geom_histogram(stat="bin", binwidth=max(bydate$steps)/15,color="dark green", fill="white")
plot1 <- plot1 + 
  labs(title="Total number of steps taken per day", x="Total steps per day", y="Frequency") + 
  geom_vline(xintercept=mean(bydate$steps), color="blue", lty=2) + 
  geom_vline(xintercept=median(bydate$steps),color="red", lty=5) + 
  annotation_custom(tableGrob(means), xmin=mean(bydate$steps)*1.5)

plot1
```

##What is the average daily activity pattern?
The dataframe byint contains the average steps at each 5-min interval. Each interval is averaged across all days reported in the data (currently with NAs removed). We can use that dataframe to make a line plot and annotate the plot with the maximum average steps taken and the 5-minute interval in which it happened. 


```{r plot2, echo=TRUE, dependson=c(1,2), cache=TRUE, fig.cap="Daily Activity Pattern"}
#calculate maximum avg. steps and its matching interval
maxint<-byint$interval[which.max(byint$steps)]
maxstep<-max(byint$steps)
maxes <- data.frame(MaxInterval=maxint, MaxSteps=round(maxstep))

plot2 <- ggplot(data=byint, aes(x=interval, y=steps))
plot2 <- plot2 + geom_line(color="red") +
  labs(title="Average Daily Activity\n in 5-minute intervals",
     x="Interval",
     y="Average Steps Taken") +
  geom_vline(xintercept=maxint, color="dark blue") +
  annotation_custom(tableGrob(maxes), xmin=maxint, ymin=maxstep*0.75)

plot2
```


##Imputing missing values
The original dataset had missing values, signified by "NA", which we initially ignored. 
The original data is stored in the dataframe `activity`, while the dataframe `act_clean` is the subset with NA removed. The `anti_join` function of the `dplyr` package can compare two datasets: [it returns all values in x that are not matched in y, and only keeps columns from x.](https://stat545-ubc.github.io/bit001_dplyr-cheatsheet.html). This will tell us which entries corresponded to the NA values. 

```{r missingdata, dependson=2}
#return na rows with anti_join
join <- anti_join(activity, act_clean)
ans<-distinct(join, as.Date(join$date))
data.frame(Total=nrow(activity), Complete=nrow(act_clean), MissingRows=nrow(join))
```

There are `r nrow(join)` missing rows to impute out of a total `r nrow(activity)`, representing time intervals missing data. 
To fill in these missing time intervals, we can use the average values from each 5-minute interval that was calculated earlier and stored in byint. Essentially, we will assume that on the 8 missing days, our anonymous "Quantified Self"-er had an activity pattern close to the average activity pattern over this period. 

```{r imputing, dependson=2, cache=TRUE}
act2<-activity
for (i in 1:nrow(act2)) {
    if (is.na(act2$steps[i])) {
        act2$steps[i] <- byint[which(act2$interval[i] == byint$interval), ]$steps
    }
}
sum(is.na(act2)) #check that there's no more NAs
head(act2) 
```

**How did imputing data affect the mean and median?**
The original dataset had data missing mostly from 8 sporadic days out of the 61 day reporting period. These missing data were imputed with a mean value, so we expect that the overall mean should not be changed much. To test this, we repeat the same process we applied to the original dataset to get a histogram with calculated mean and median. 

```{r plot3, dependson=c(2,3,6), fig.cap="Before and After Imputing Missing Data"}
bydate2 <- act2 %>% 
        group_by(date) %>%
        summarize(steps=sum(steps)) 
means <- data.frame(NewMean=signif(mean(bydate2$steps), digits=7), NewMedian=signif(median(bydate2$steps), digits=7))
plot3 <- ggplot(data=bydate2, aes(steps))
plot3 <- plot3 + geom_histogram(stat="bin", binwidth=max(bydate2$steps)/15,color="dark green", fill="white") + ylim(0,22)
plot3 <- plot3 + 
  labs(title="Total number of steps taken per day (Imputed Data)", x="Total steps per day", y="Frequency") + 
  geom_vline(xintercept=mean(bydate2$steps), color="blue", lty=2) + 
  geom_vline(xintercept=median(bydate2$steps),color="red", lty=5) + 
  annotation_custom(tableGrob(means),  xmin=mean(bydate$steps)*1.5)
#place new histogram next to original histogram
plot1 <- plot1 + ylim(0,22)
grid.arrange(plot3, plot1, nrow=2)
```

We can confirm that the mean and median have not changed much in the imputed data. The mean stayed the same at `r round(mean(bydate$steps))` but the median changed slightly from `r median(bydate$steps)` to `r signif(median(bydate2$steps), digits=7)`.

##Are there differences in activity patterns between weekdays and weekends?

```{r plot4, dependson=c(2,3,6), fig.cap="Daily activity on Weekdays vs. Weekends"}
#change date format in dataset
act2$date <- as.Date(strptime(act2$date, format="%Y-%m-%d"))
#create a "day of week" variable
act2$dow <- weekdays(act2$date)
#Subset the data into Weekend and Weekday, and replace day of week 
wkend <- act2 %>%
        subset(dow %in% c("Saturday", "Sunday")) %>%
        mutate(dow2="Weekend")
wkday <- act2 %>% 
        subset(!dow %in% c("Saturday", "Sunday")) %>%
        mutate(dow2="Weekday")
#combine the two sets
act3 <- rbind(wkday, wkend)    
#get aggregate dataset for plot
act4 <- act3 %>%
        group_by(interval, dow2) %>%
        summarize(steps=mean(steps))
plot4 <- ggplot(data=act4, aes(x=interval, y=steps)) + 
  geom_line(color="dark green", type="l", aes(group=dow2)) + 
  facet_grid(dow2~., scales="free", space="free")
plot4 <- plot4 + 
  labs(x="Interval", 
       y="Mean Steps", 
       title="Mean Steps by 5-min Interval\n Weekend vs. Weekdays") 
print(plot4)
```

From this plot, we see that on weekends, there are more intervals where the number of steps is >100. On weekdays, there is a peak of activity in the mornings, around 8-9AM. So the overall activity on weekends seems to be higher but the weekdays have the biggest 5-min peak, at 8:30. This pattern fits with a person who takes a walk every weekday morning, or walks to work. This person's weekends are fairly active, and they seem to spend a greater part of the weekend days moving around. 

